<!doctype html>
<head>
  <style>
    .menuDiv {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .verticalDiv {
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  {% if user.is_authenticated %}
  <div id="friends-menu" class="verticalDiv">
    <button onclick="render({% url 'friendInvitesSent' %})">
      Invites Sent
    </button>
    <button onclick="render({% url 'friendInvitesReceived' %})">
      Invites Received
    </button>
    <button onclick="render({% url 'sendFriendInvites' %})">Add friends</button>
    <button onclick="renderFriendList()">Friendlist</button>
  </div>
  <div id="friends-rendered-data"></div>
  {% else %}
  <p>Welcome, new user. Please <a href="/">Login</a></p>
  {% endif %}
</body>

<script>
  // General functions \\
  window.addEventListener("popstate", handlePopState);

  function handlePopState(event) {
    console.log("went to page: " + event.state?.view);
    render(event.state?.view, false);
  }

  function handleForm(event) {
    event.preventDefault();

    const form = event.target;
    const data = new FormData(form);
    const url = data.get("url");

    fetch(url, {
      method: form.method,
      body: data,
    })
      .then((response) => response.text())
      .then((data) => {
        document.getElementById("friends-rendered-data").innerHTML = data;
      });
  }

  function render(url, setPushState = true) {
    fetch(url)
      .then((response) => response.text())
      .then((data) => {
        document.getElementById("friends-rendered-data").innerHTML = data;
        if (setPushState) {
          history.pushState({ view: url }, "", url);
        }
      });
  }
  // END \\

  // FRIENDS RELATED FUNCTIONS FOR THE SPA \\
  async function renderFriendList() {
    await fetch("{% url 'friendList' %}")
      .then((response) => response.text())
      .then((html) => {
        const container = document.getElementById("friends-rendered-data");
        container.innerHTML = html;
      });
    setInitialStatus();
  }

  let onlineUsers = [];

  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/status/",
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    if ("connected_user" in data) {
      setOnline(data["connected_user"]);
    } else if ("disconnected_user" in data) {
      setOffline(data["disconnected_user"]);
    } else {
      onlineUsers = data["online_users"];
      setInitialStatus();
    }
  };

  chatSocket.onclose = function (e) {};

  function setInitialStatus() {
    onlineUsers.forEach((element) => {
      try {
        document.getElementById(element).textContent = "ON";
      } catch (e) {}
    });
  }

  function setOnline(user) {
    try {
      onlineUsers.push(user);
      document.getElementById(user).textContent = "ON";
    } catch (e) {}
  }

  function setOffline(user) {
    try {
      onlineUsers.splice(onlineUsers.indexOf(user));
      document.getElementById(user).textContent = "OFF";
    } catch (e) {}
  }
  // END \\
</script>
